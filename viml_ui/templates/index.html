{% extends "base.html" %}

{% block content %}
<div class="mb-8">
    <h2 class="text-3xl font-bold mb-2">Command Center</h2>
    <p class="text-gray-400">System Overview & Job Status</p>
</div>

<!-- Stats Grid -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="glass p-6 rounded-xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Active Jobs</h3>
        <p class="text-3xl font-bold text-white" id="stat-active">0</p>
    </div>
    <div class="glass p-6 rounded-xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Items in Review</h3>
        <p class="text-3xl font-bold text-yellow-400" id="stat-review">0</p>
    </div>
    <div class="glass p-6 rounded-xl">
        <h3 class="text-gray-400 text-sm font-medium mb-1">Processed Today</h3>
        <p class="text-3xl font-bold text-green-400" id="stat-processed">0</p>
    </div>
</div>

<!-- Recent Jobs Table -->
<div class="glass rounded-xl overflow-hidden">
    <div class="px-6 py-4 border-b border-gray-700 flex justify-between items-center">
        <h3 class="font-semibold">Recent Activity</h3>
        <button onclick="fetchJobs()" class="text-sm text-blue-400 hover:text-blue-300">Refresh</button>
    </div>
    <table class="w-full text-left">
        <thead class="bg-gray-800 text-gray-400 text-xs uppercase">
            <tr>
                <th class="px-6 py-3">Job ID</th>
                <th class="px-6 py-3">Status</th>
                <th class="px-6 py-3">Created At</th>
            </tr>
        </thead>
        <tbody class="divide-y divide-gray-700 text-sm" id="jobs-table-body">
            <tr>
                <td colspan="3" class="px-6 py-4 text-center text-gray-500">Loading...</td>
            </tr>
        </tbody>
    </table>
</div>
{% endblock %}

{% block scripts %}
<script>
    async function fetchJobs() {
        try {
            const res = await fetch('/v1/jobs');
            const jobs = await res.json();

            // Stats logic
            const active = jobs.filter(j => ['queued', 'processing'].includes(j.status)).length;
            const completed = jobs.filter(j => j.status === 'completed').length;

            document.getElementById('stat-active').innerText = active;
            document.getElementById('stat-processed').innerText = completed; // Rough approximation for 'Today'

            // Fetch review count separately if needed, or assume 'pending' jobs are in review
            // For now, let's keep review stat as placeholder or fetch from /review/queue count
            fetch('/v1/review/queue').then(r => r.json()).then(q => {
                document.getElementById('stat-review').innerText = q.length;
            });

            const tbody = document.getElementById('jobs-table-body');
            if (jobs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-gray-500">No recent jobs found</td></tr>';
                return;
            }

            tbody.innerHTML = jobs.map(job => `
                <tr class="hover:bg-gray-800 transition-colors">
                    <td class="px-6 py-4 font-mono text-xs text-blue-400">
                        <a href="/v1/jobs/${job.job_id}" target="_blank" class="hover:underline">${job.job_id.substring(0, 8)}...</a>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 rounded text-xs font-bold ${getStatusColor(job.status)}">
                            ${job.status.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-gray-400">${formatDate(job.created_at)}</td>
                </tr>
            `).join('');

        } catch (e) {
            console.error(e);
            document.getElementById('jobs-table-body').innerHTML = '<tr><td colspan="3" class="px-6 py-4 text-center text-red-500">Error loading jobs</td></tr>';
        }
    }

    function getStatusColor(status) {
        if (status === 'completed') return 'bg-green-900 text-green-200';
        if (status === 'failed') return 'bg-red-900 text-red-200';
        if (status === 'processing') return 'bg-blue-900 text-blue-200';
        return 'bg-gray-700 text-gray-300';
    }

    function formatDate(dateStr) {
        if (!dateStr) return '';
        return new Date(dateStr).toLocaleString();
    }

    // Auto-load
    fetchJobs();
</script>
{% endblock %}